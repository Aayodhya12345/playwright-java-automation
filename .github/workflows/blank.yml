name: CI (Jira cloud example with GH action)
on: [push]
jobs:
  build:
    runs-on: windows-latest
         
    steps:
    - uses: actions/checkout@v4
    - name: Set up Java
      uses: actions/setup-java@v1
      with:
        java-version: '1.8' 
    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    - name: Build with Maven
      run: mvn clean compile test --file pom.xml
    - name: Get Xray Authentication Token
      id: get-token
      run: |
        RESPONSE=$(curl -s -X POST https://xray.cloud.getxray.app/api/v2/authenticate \ -H "Content-Type: application/json" \ -d "{\"client_id\": \"${{ secrets.CLIENT_ID }}\", \"client_secret\": \"${{ secrets.CLIENT_SECRET }}\"}")

        TOKEN=$(echo $RESPONSE | sed 's/"//g')
        echo "XRAY_TOKEN=$TOKEN" >> $GITHUB_ENV

    - name: Upload Result to Xray
      run: |
        curl -H "Content-Type: application/json" \ -H "Authentication: Bearer $XRAY_TOKEN" \ -X POST https://xray.cloud.getxray.app/api/v2/import/execution \ --data @"results.json"
